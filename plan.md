# План и Архитектура на Проекта "EspHub"

Този документ описва еволюцията и финалната архитектура на проекта EspHub, базиран на проведените разговори.

## 1. Основна Цел

Създаване на гъвкава, надеждна и бързо възстановяваща се система за домашна автоматизация, базирана на ESP32. Системата трябва да може да работи автономно, да изпълнява локална PLC логика и да се интегрира с по-големи системи като Home Assistant, решавайки проблема с бавното стартиране на централизирани сървъри след спиране на захранването.

## 2. Еволюция на Идеята

Проектът премина през няколко ключови етапа на развитие:

1.  **Начална Концепция (Star-мрежа):**
    *   Единичен ESP32 хъб, комуникиращ с периферни устройства (сензори, ключове) чрез `ESP-NOW` за бърза реакция.
    *   Връзка към Home Assistant чрез MQTT.

2.  **Добавяне на PLC Логика:**
    *   Идеята се разшири с добавянето на PLC (Програмируем логически контролер) функционалност, която да работи локално на хъба.
    *   Първоначално беше предвидена проста `IF-THEN` структура за правилата.

3.  **Разширена PLC Архитектура:**
    *   Потребителските изисквания еволюираха до нуждата от пълноценен PLC двигател.
    *   **Модул за памет (`PlcMemory`):** Дефинирани са различни типове данни (`bool`, `int`, `real` и др.) и "retentive" памет, която запазва стойностите си след рестарт.
    *   **Модулна логика:** Проектирана е структура за бъдещо добавяне на изолирани функционални блокове (AND, OR, TON, броячи и др.).
    *   **Паралелно изпълнение:** PLC двигателят е преместен в отделна FreeRTOS задача, "закачена" за второто ядро на ESP32, за да се гарантира стабилно и предвидимо изпълнение, независимо от мрежовите операции.
    *   **Run/Stop контрол:** Добавена е възможност за стартиране и спиране на PLC програмата чрез MQTT команди, както и защита срещу зареждане на нова конфигурация по време на работа.

4.  **Преминаване към Mesh Мрежа:**
    *   За по-голямо покритие и надеждност, архитектурата премина от "star" мрежа към `painlessMesh`.
    *   Всеки `EspHub` вече може да действа и като мрежов разширител (extender).
    *   **Единствен MQTT Gateway:** Само един хъб в мрежата (root нодът) се свързва към MQTT брокера, централизирайки външната комуникация.

5.  **Подобрения в Потребителското Изживяване:**
    *   **WiFiManager:** Интегриран е Captive Portal за лесна първоначална настройка на Wi-Fi връзката без нужда от твърдо кодирани пароли.
    *   **Live Debug Logger:** Създаден е уеб-базиран логър с WebSockets, достъпен на `/log`, за дебъгване на системата в реално време през Wi-Fi.

## 3. Финална Архитектура

*   **Мрежова Комуникация:**
    *   **Вътрешна:** `painlessMesh` за самоорганизираща се и самолекуваща се mesh мрежа между `EspHub` нодовете.
    *   **Външна:** Единствен MQTT Gateway (root нодът) за връзка с MQTT брокер (Home Assistant).

*   **PLC Двигател (`PlcCore`):**
    *   Работи на отделно процесорно ядро (Core 0) чрез FreeRTOS.
    *   Управлява се с `run`/`stop` команди по MQTT.
    *   Използва модул за памет с поддръжка на различни типове данни и retentive памет.
    *   Конфигурира се чрез JSON, изпратен по MQTT, с отделни блокове за `memory` и `logic`.

*   **Основна Библиотека (`EspHubLib`):**
    *   Капсулира цялата основна функционалност.
    *   Управлява `painlessMesh`, `MqttManager`, `PlcEngine` и `WebManager`.

*   **Структура на Проекта:**
    *   `lib/EspHubLib/`: Основната библиотека на хъба.
    *   `lib/PlcCore/`: Изолираната библиотека за PLC функционалността.
    *   `examples/`: Съдържа примери за използване (напр. фърмуер за периферно устройство).
    *   `src/main.cpp`: Основен файл на приложението, който използва `EspHubLib`.

## 4. Следващи Стъпки

1.  **Имплементация на Функционални Блокове:** Създаване на файлове в `lib/PlcCore/blocks/` за всеки логически оператор (AND, OR, TON, броячи и др.).
2.  **Развитие на `PlcEngine::evaluate()`:** Имплементиране на логиката, която чете `logic` блока от JSON конфигурацията и изпълнява веригата от функционални блокове.
3.  **Разширяване на Уеб Интерфейса:** Изграждане на пълноценен UI на базата на `WebManager` за:
    *   Мониторинг на нодовете в mesh мрежата.
    *   Визуализация на PLC паметта в реално време.
    *   Управление на I/O на устройствата.
4.  **Имплементация на Retentive Memory:** Дописване на `load/save` методите в `PlcMemory`, за да използват NVS.
5.  **Актуализация на примера `EspDevice`:** Преработване на примера да използва `painlessMesh` вместо `ESP-NOW`.