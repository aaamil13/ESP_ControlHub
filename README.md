# EspHub Project

EspHub е гъвкав хъб за домашна автоматизация, базиран на ESP32, който използва `painlessMesh` за бърза локална комуникация и MQTT за интеграция с по-големи системи като Home Assistant. Проектът е проектиран да работи автономно, да изпълнява локална PLC логика и да бъде устойчив на прекъсвания на интернет връзката.

## Архитектура

Проектът се състои от няколко основни компонента:

*   **`EspHubLib`**: Основна библиотека, която капсулира цялата функционалност на хъба.
*   **`PlcCore`**: Изолирана библиотека за PLC функционалността, работеща на отделно процесорно ядро.
*   **`AppManager`**: Управлява високо-ниво приложни модули (напр. термостати, поливни системи).
*   **`MeshDeviceManager`**: Управлява mesh устройствата, тяхната регистрация и статус.
*   **`WebManager`**: Управлява уеб интерфейса за конфигурация, мониторинг и OTA ъпдейти.
*   **`TimeManager`**: Управлява синхронизацията на времето чрез NTP.
*   **`StreamLogger`**: Пренасочва лог съобщенията към сериен порт и уеб интерфейс.

## PLC JSON Схема

PLC логиката се конфигурира чрез JSON обект, изпратен по MQTT на тема `esphub/config/plc`. Конфигурацията се състои от следните елементи:

*   **`watchdog_timeout_ms`**: (Опционално) Време в милисекунди, след което, ако PLC задачата не отговори, устройството ще се рестартира. По подразбиране е 5000.
*   **`memory`**: Блок за деклариране на променливи.
*   **`init`**: (Опционално) Блок с еднократни действия, които се изпълняват при стартиране на PLC програмата, за да се зададе начално състояние.
*   **`logic`**: Блок за описване на цикличната логическа мрежа.
*   **`applications`**: Блок за конфигуриране на високо-ниво приложни модули.

### 1. Блок `memory`

Този блок декларира всички променливи, които ще се използват в PLC програмата.

```json
"memory": {
  "име_на_променлива_1": { "type": "тип", "retentive": false, "mesh_link": "sensor_id" },
  "име_на_променлива_2": { "type": "тип", "retentive": true, "mesh_link": "actuator_id" }
}
```

*   **`име_на_променлива`**: Уникално име на променливата.
*   **`type`**: Тип на данните. Поддържани стойности: `bool`, `byte`, `int`, `dint`, `real`, `string`.
*   **`retentive`**: `true` или `false`. Ако е `true`, стойността на променливата ще се запазва след рестарт на хъба.
*   **`mesh_link`**: (Опционално) Идентификатор на mesh устройство, към което е свързана тази променлива. Използва се за автоматично обновяване на стойности от сензори или изпращане на команди към актуатори.

### 2. Блок `init` (Опционален)

Този блок дефинира списък от действия, които се изпълняват **еднократно** при стартиране на PLC програмата. Той е идеален за задаване на безопасно начално състояние на изходите.

```json
"init": [
  {
    "action": "set_value",
    "variable": "switch.living_room.heater",
    "value": false
  }
]
```
*   **`action`**: Тип на действието. Засега се поддържа само `set_value`.
*   **`variable`**: Името на променливата от `memory` блока, чиято стойност ще се зададе.
*   **`value`**: Началната стойност.

### 3. Блок `logic`

Този блок описва **циклично изпълняваната** логическа мрежа, като свързва променливи с входовете и изходите на функционални блокове.

```json
"logic": [
  {
    "block_type": "AND",
    "inputs": {
      "in1": "име_на_входна_променлива_1",
      "in2": "име_на_входна_променлива_2"
    },
    "outputs": {
      "out": "име_на_изходна_променлива"
    }
  }
]
```

*   **`block_type`**: Тип на функционалния блок (напр. `AND`, `OR`, `TON`, `CTU`, `ADD`, `GT`, `TIME_COMPARE`, `BOOL_ARRAY_TO_INT8`, `SEQUENCER`).
*   **`inputs`**: Обект, който свързва входовете на блока с имена на променливи от `memory` блока или с константни стойности.
*   **`outputs`**: Обект, който свързва изходите на блока с имена на променливи от `memory` блока.

**Поддържани PLC Блокове:**

*   **Логически операции**: `AND`, `OR`, `NOT`, `XOR`, `NAND`, `NOR`, `SR` (Set-Reset Latch), `RS` (Reset-Set Latch)
*   **Таймери**: `TON` (Timer ON Delay), `TOF` (Timer OFF Delay), `TP` (Pulse Timer)
*   **Броячи**: `CTU` (Count Up), `CTD` (Count Down), `CTUD` (Count Up/Down)
*   **Математически операции**: `ADD`, `SUB`, `MUL`, `DIV`, `MOD` (Modulo), `ABS` (Absolute Value), `SQRT` (Square Root), `INC` (Increment), `DEC` (Decrement)
*   **Сравнения**: `EQ` (Equal), `NE` (Not Equal), `GT` (Greater Than), `LT` (Less Than), `GE` (Greater or Equal), `LE` (Less or Equal)
*   **Времеви блокове**: `TIME_COMPARE` (сравнява текущо време с конфигурирано)
*   **Преобразуване на типове данни**: `BOOL_ARRAY_TO_INT8`, `INT8_TO_INT16`, `INT8_TO_UINT8`, `INT16_TO_UINT16`, `INT32_TO_TIME`, `INT16_TO_FLOAT`, `INT32_TO_DOUBLE`
*   **Последователности**: `SEQUENCER` (за изпълнение на стъпкови програми)

### 4. Блок `applications`

Този блок позволява на потребителите да инстанцират и конфигурират предефинирани, високо-ниво модули, без да се налага да пишат PLC логика.

```json
"applications": [
  {
    "type": "thermostat",
    "config": {
      "temp_sensor": "sensor.living_room.temperature",
      "heater_output": "switch.living_room.heater",
      "setpoint": 22.5
    }
  }
]
```

*   **`type`**: Името на приложния модул (напр. `thermostat`, `irrigation`).
*   **`config`**: Обект със специфични за модула настройки.

## Mesh Комуникационен Протокол

Комуникацията между `EspHub` нодовете в mesh мрежата се осъществява чрез JSON съобщения.

### Типове Съобщения (`MeshMessageType`)

*   `MESH_MSG_TYPE_REGISTRATION`: За регистрация на ново устройство в мрежата.
*   `MESH_MSG_TYPE_SENSOR_DATA`: За изпращане на данни от сензори.
*   `MESH_MSG_TYPE_ACTUATOR_COMMAND`: За изпращане на команди към актуатори.
*   `MESH_MSG_TYPE_HEARTBEAT`: За периодично потвърждение на активност.

### Пример за `SENSOR_DATA` съобщение

```json
{
  "type": 2, // MESH_MSG_TYPE_SENSOR_DATA
  "var_name": "livingRoomTemp",
  "value": 22.5
}
```

## Уеб Интерфейс

`EspHub` предоставя уеб интерфейс за:

*   **Wi-Fi Конфигурация**: Чрез `WiFiManager` (Captive Portal) за лесна първоначална настройка на Wi-Fi и mesh парола.
*   **Live Log**: На адрес `/log` за наблюдение на системни събития в реално време.
*   **OTA Ъпдейти**: На адрес `/update` за качване на нов фърмуер по въздуха.
*   **PLC Конфигурация**: На адрес `/plc_config` за качване на JSON файл с PLC логика.

## Бъдещи Подобрения

*   **Пълна имплементация на `PlcMemory` NVS**: Запазване и зареждане на retentive променливи.
*   **Разширяване на `WebManager`**:
    *   Страница за мониторинг на PLC променливи и статус на mesh устройства.
    *   Страница за регистрация на mesh устройства.
*   **Разширяване на PLC Блокове**: Добавяне на още логически, математически, времеви и комуникационни блокове.
*   **Примерни Приложни Модули**: Имплементация на `ThermostatApp`, `IrrigationApp` и други.
*   **MQTT Discovery за Home Assistant**: Автоматично откриване на устройства и сензори в Home Assistant.
*   **OTA чрез MQTT**: Възможност за стартиране на OTA ъпдейт чрез MQTT команда.